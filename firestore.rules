/**
 * @file Firestore Security Rules for NGO Community Tracker
 * @description This ruleset enforces a strict, path-based ownership model combined with denormalized authorization to ensure secure access to household, child, follow-up visit, and progress update data.
 *
 * Data Structure:
 * - /households/{householdId}: Stores household information. May include a `members` map for collaborative access.
 * - /households/{householdId}/children/{childId}: Stores child data associated with a household.
 * - /households/{householdId}/followUpVisits/{followUpVisitId}: Stores follow-up visit data for a household.
 * - /households/{householdId}/children/{childId}/childProgressUpdates/{childProgressUpdateId}: Stores progress updates for children during visits.
 *
 * Key Security Decisions:
 * - All write operations are restricted to authorized users, typically household owners or members.
 * - Read operations (get, list) are generally restricted to owners, but may be public in certain scenarios (e.g., listing public households - not implemented here).
 * - Denormalization is used extensively to ensure that authorization checks can be performed efficiently without additional reads.
 * - The rules do not validate the detailed schema of the data, focusing instead on authorization and relational integrity.
 *
 * Denormalization for Authorization:
 * - The `householdId` is denormalized into the `Child`, `FollowUpVisit`, and `ChildProgressUpdate` documents to allow for direct authorization checks without needing to query the parent `Household` document.
 *
 * Structural Segregation:
 * - Data is segregated into collections based on entity type (Households, Children, FollowUpVisits, ChildProgressUpdates) to maintain a homogeneous security posture.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages access to household data.
     * @path /households/{householdId}
     * @allow (create) - An authenticated user can create a household with an ID that matches the householdId.
     * @allow (get, update, delete) - An authenticated user can get, update, or delete a household if they are the owner (the householdId matches the user ID).
     * @deny (create) - An unauthenticated user attempts to create a household.
     * @deny (update, delete) - An unauthenticated user attempts to update or delete a household.
     * @principle Enforces document ownership for writes; allows public reads.
     */
    match /households/{householdId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(householdId) {
        return request.auth.uid == householdId;
      }

      function isExistingOwner(householdId) {
        return isSignedIn() && isOwner(householdId) && resource != null;
      }

      // Anyone can read household data
      allow get, list: if true;

      // Only the owner can create the household, and the ID must match.
      allow create: if isSignedIn() && request.resource.data.id == householdId;

      // Only the owner can update or delete the household
      allow update: if isExistingOwner(householdId);
      allow delete: if isExistingOwner(householdId);
    }

    /**
     * @description Manages access to child data associated with a specific household.
     * @path /households/{householdId}/children/{childId}
     * @allow (create) - An authenticated user can create a child document under a household if the householdId in the path matches the householdId in the document.
     * @allow (get, list, update, delete) - An authenticated user can get, list, update, or delete a child document if they are the owner of the parent household.
     * @deny (create) - An unauthenticated user attempts to create a child document.
     * @deny (update, delete) - An unauthenticated user attempts to update or delete a child document if they are not the owner of the parent household.
     * @principle Enforces document ownership and relational integrity for writes; allows owner-only reads/writes.
     */
    match /households/{householdId}/children/{childId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isHouseholdOwner(householdId) {
        return request.auth.uid == householdId;
      }

      function isExistingHouseholdOwner(householdId) {
        return isSignedIn() && isHouseholdOwner(householdId) && resource != null;
      }

      // Only the household owner can list children.
      allow list: if isHouseholdOwner(householdId);
      allow get: if isHouseholdOwner(householdId);

      // Only the household owner can create a child, and the householdId must match.
      allow create: if isSignedIn() && request.resource.data.householdId == householdId;

      // Only the household owner can update or delete the child
      allow update: if isExistingHouseholdOwner(householdId);
      allow delete: if isExistingHouseholdOwner(householdId);
    }

    /**
     * @description Manages access to follow-up visit data for a specific household.
     * @path /households/{householdId}/followUpVisits/{followUpVisitId}
     * @allow (create) - An authenticated user can create a follow-up visit document under a household if the householdId in the path matches the householdId in the document.
     * @allow (get, list, update, delete) - An authenticated user can get, list, update, or delete a follow-up visit document if they are the owner of the parent household.
     * @deny (create) - An unauthenticated user attempts to create a follow-up visit document.
     * @deny (update, delete) - An unauthenticated user attempts to update or delete a follow-up visit document if they are not the owner of the parent household.
     * @principle Enforces document ownership and relational integrity for writes; allows owner-only reads/writes.
     */
    match /households/{householdId}/followUpVisits/{followUpVisitId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isHouseholdOwner(householdId) {
        return request.auth.uid == householdId;
      }

      function isExistingHouseholdOwner(householdId) {
        return isSignedIn() && isHouseholdOwner(householdId) && resource != null;
      }

      // Only the household owner can list follow-up visits.
      allow list: if isHouseholdOwner(householdId);
      allow get: if isHouseholdOwner(householdId);

      // Only the household owner can create a follow-up visit, and the householdId must match.
      allow create: if isSignedIn() && request.resource.data.householdId == householdId;

      // Only the household owner can update or delete the follow-up visit
      allow update: if isExistingHouseholdOwner(householdId);
      allow delete: if isExistingHouseholdOwner(householdId);
    }

    /**
     * @description Manages access to child progress update data associated with a specific child and follow-up visit.
     * @path /households/{householdId}/children/{childId}/childProgressUpdates/{childProgressUpdateId}
     * @allow (create) - An authenticated user can create a child progress update document if the householdId and childId in the path match the corresponding fields in the document.
     * @allow (get, list, update, delete) - An authenticated user can get, list, update, or delete a child progress update document if they are the owner of the parent household.
     * @deny (create) - An unauthenticated user attempts to create a child progress update document.
     * @deny (update, delete) - An unauthenticated user attempts to update or delete a child progress update document if they are not the owner of the parent household.
     * @principle Enforces document ownership and relational integrity for writes; allows owner-only reads/writes.
     */
    match /households/{householdId}/children/{childId}/childProgressUpdates/{childProgressUpdateId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isHouseholdOwner(householdId) {
        return request.auth.uid == householdId;
      }

      function isExistingHouseholdOwner(householdId) {
        return isSignedIn() && isHouseholdOwner(householdId) && resource != null;
      }

      // Only the household owner can list child progress updates.
      allow list: if isHouseholdOwner(householdId);
      allow get: if isHouseholdOwner(householdId);

      // Only the household owner can create a child progress update, and the householdId and childId must match.
      allow create: if isSignedIn() && request.resource.data.childId == childId;

      // Only the household owner can update or delete the child progress update
      allow update: if isExistingHouseholdOwner(householdId);
      allow delete: if isExistingHouseholdOwner(householdId);
    }
  }
}